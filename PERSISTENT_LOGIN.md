# 客户端登录状态持久化说明

## 功能更新

现在Flutter客户端已经支持登录状态持久化，用户登录后即使重启应用也会保持登录状态。

## 主要改进

### 1. 本地存储支持
- 使用`shared_preferences`库存储用户认证信息
- Token和用户数据会自动保存到本地
- 应用重启时自动加载已保存的认证信息

### 2. 启动时认证检查
- 应用启动时显示加载界面
- 自动加载本地存储的认证数据
- 验证Token有效性，如果过期会自动清除

### 3. 智能状态管理
- 登录成功后自动保存到本地
- 退出登录时清除所有本地数据
- Token失效时自动清理本地存储

## 使用方法

### 安装依赖
确保在pubspec.yaml中已添加：
```yaml
dependencies:
  shared_preferences: ^2.2.2
```

然后运行：
```bash
flutter pub get
```

### 测试流程

1. **首次登录**：
   - 启动应用
   - 进行用户注册或登录
   - 登录成功后关闭应用

2. **验证持久化**：
   - 重新启动应用
   - 应该自动显示已登录状态
   - 可以正常访问排行榜等需要登录的功能

3. **退出登录**：
   - 点击用户状态栏的"退出"按钮
   - 重启应用后应显示未登录状态

## 调试功能

### 调试日志
AuthService现在会输出详细的调试日志：
- 登录状态检查
- 本地数据加载/保存
- Token验证结果

### 调试按钮
在主页的用户状态栏中：
- 未登录时显示"刷新状态"按钮
- 可以手动触发状态检查

## 数据安全

### 存储内容
- Token: 用于服务器认证
- 用户基本信息: 用户名、邮箱、ID

### 安全考虑
- Token有过期时间限制
- 应用启动时会验证Token有效性
- 无效Token会自动清除
- 密码不会存储在本地

## 故障排除

### 如果登录状态未保持
1. 检查是否正确安装了shared_preferences依赖
2. 查看控制台调试日志
3. 确认服务器正在运行
4. 尝试重新登录

### 如果出现Token过期
- 这是正常行为，重新登录即可
- Token有30天有效期
- 过期后应用会自动清除本地数据

### 清除所有数据
如果需要完全重置：
1. 退出登录
2. 或者卸载重装应用
3. 或者清除应用数据（Android设置中）

## 技术实现

### 核心类更新
- `AuthService`: 增加本地存储支持
- `main.dart`: 启动时数据加载
- `HomePage`: 智能状态刷新

### 存储机制
- 使用SharedPreferences存储
- JSON格式序列化用户数据
- 异步加载和保存

### 生命周期管理
- 应用启动: 加载本地数据
- 登录成功: 保存到本地
- 退出登录: 清除本地数据
- Token验证: 自动清理无效数据